---
description: |
  Install local package dependencies with
  `opam install . --deps-only --with-test -y`

parameters:
  cache_depends:
    description: |
      Whether to cache dependencies
    type: boolean
    default: false

  depends_cache_reference_file:
    description: |
      File to use as a checksum reference for dependencies caching
    type: string
    default: ''

steps:
  - when:
      condition: << parameters.cache_depends >>
      steps:
        - restore_cache:
            keys:
              - v12-opam-packages-{{ checksum "<< parameters.depends_cache_reference_file >>" }}-{{ .Branch }}
              - v12-opam-packages-{{ checksum "<< parameters.depends_cache_reference_file >>" }}-
              - v12-opam-packages-
  - run:
      name: Install project dependencies
      command: |
        opam install . --deps-only --with-test -y
  - when:
      condition: << parameters.cache_depends >>
      steps:
        - save_cache:
            paths:
              - _opam/bin
              - _opam/doc
              - _opam/.opam-switch
              - _opam/man
              - _opam/share
              - _opam/lib
              - _opam/sbin
            key: v12-opam-packages-{{ checksum "<< parameters.depends_cache_reference_file >>" }}-{{ .Branch }}
