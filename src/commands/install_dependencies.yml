---
description: |
  Install local package dependencies with
  `opam install . --deps-only --with-test -y`

parameters:
  cache_depends:
    description: |
      Whether to cache dependencies
    type: boolean
    default: false

  depends_cache_reference_file:
    description: |
      File to use as a checksum reference for dependencies caching
    type: string
    default: ''

steps:
  - when:
      condition: << parameters.cache_depends >>
      steps:
        - run:
            name: Linking dependencies directory
            command: |
              eval $(opam env)
              ln -vs ${OPAM_SWITCH_PREFIX}/lib ~/deps-lib
        - restore_cache:
            keys:
              - v7-opam-packages-{{ checksum "<< parameters.depends_cache_reference_file >>" }}-{{ .Branch }}
              - v7-opam-packages-{{ checksum "<< parameters.depends_cache_reference_file >>" }}-
              - v7-opam-packages-
  - run:
      name: Install project dependencies
      command: |
        opam install . --deps-only --with-test -y
  - when:
      condition: << parameters.cache_depends >>
      steps:
        - save_cache:
            paths:
              - ~/deps-lib
            key: v7-opam-packages-{{ checksum "<< parameters.depends_cache_reference_file >>" }}-{{ .Branch }}
