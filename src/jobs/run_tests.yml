---
description: |
  Installs dependencies and runs local package's test suite

parameters:
  executor:
    description: |
      Executor name
    type: executor
    default: default

  switch_name:
    description: |
      Used OPAM switch name a.k.a. compiler version
      (OPAM docker image may contain several of them).
    type: string

  depext_pkgs:
    description: |
      Space-separated list of packages that need depexts
    type: string
    default: ""

  cache_depends:
    description: |
      Whether to cache dependencies
    type: boolean
    default: false

  depends_cache_reference_file:
    description: |
      File to use as a checksum reference for dependencies caching
    type: string
    default: ""

executor: << parameters.executor >>

steps:
  - checkout
  - link_local_switch:
      switch_name: << parameters.switch_name >>
  - install_depexts:
      pkgs: << parameters.depext_pkgs >>
  - install_dependencies:
      cache_depends: << parameters.cache_depends >>
      depends_cache_reference_file: << parameters.depends_cache_reference_file >>
  - run_tests
